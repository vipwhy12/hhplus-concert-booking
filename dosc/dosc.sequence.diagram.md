# 콘서트 예약 시퀀스 다이어그램 작성 보고서

## 1. 용어 정리

### 1.1 콘서트

- **콘서트**는 특정 기간 동안 여러 날짜에 걸쳐 진행될 수 있는 공연을 의미합니다. 하나의 콘서트는 **여러 개의 날짜**를 가질 수 있으며, **매 콘서트마다 여러 회차**로 나뉠 수 있습니다.

### 1.2 서비스 이용권 (Service Token)

- **서비스 이용권**은 사용자가 특정 서비스를 이용할 수 있는 권한을 나타냅니다. 일반적으로 "토큰"이라는 용어로 표현되며, 서비스 접근에 필요한 **사용자 정보**와 **상태 정보**가 포함됩니다. 주요 속성은 다음과 같습니다:
    - **사용자 ID**: 특정 사용자를 식별하기 위한 고유한 ID입니다.
    - **상태**: 서비스 이용 가능 여부를 나타내는 정보로, "대기", "활성화", 또는 "없음" 등의 상태를 가질 수 있습니다.

### 1.3 대기열 (Queue)

- **대기열**은 사용자가 서비스를 이용하기 위해 대기하는 상태를 관리하는 시스템입니다. 사용자가 많은 경우, 서비스를 순차적으로 이용할 수 있도록 **대기 순서**를 부여하고, **예상 대기 시간**을 제공하여 서비스 이용 준비 상태를 안내합니다. 대기열 시스템의 주요 요소는 다음과 같습니다:
    - **대기 순서**: 사용자가 몇 번째로 서비스를 사용할 수 있는지를 나타냅니다.
    - **예상 대기 시간**: 사용자가 대기 상태에서 남은 시간을 추정하여 보여줍니다.
    - **상태 변화**: 대기열에서 사용자의 상태가 변할 때, 예를 들어 순서가 앞당겨지거나 서비스 이용이 가능해지면 상태가 업데이트됩니다.

## 2. Use Case 중심 설계

시퀀스 다이어그램을 **Use Case(UC) 중심**으로 작성한 이유는 시스템이 사용자의 요구를 중심으로 어떻게 동작하는지를 명확히 보여주기 위함입니다. UC 중심 다이어그램은 사용자가 시스템과 어떻게 상호작용하는지 직관적으로 파악할 수 있도록 하며, 시스템이 요구사항에 따라 어떤 방식으로 처리되는지 시각적으로 표현합니다. 이러한 접근법은 개발 및 이해를 용이하게 하며, 요구사항 충족 여부를 쉽게 확인할 수 있도록 합니다.

### 주요 유스 케이스

### 대기열 관련

1. **유저 대기열 신청**: 사용자가 서비스를 이용하기 위해 대기열에 등록합니다.
2. **유저 대기열 확인**: 사용자가 본인의 대기 상태를 확인합니다.

### 콘서트 관련

1. **예약 가능 날짜 조회**: 콘서트의 예약 가능한 날짜 목록을 조회합니다.
2. **예약 가능 날짜의 좌석 조회**: 선택한 날짜에 예약 가능한 좌석 목록을 조회합니다.
3. **콘서트 좌석 요청**: 사용자가 원하는 날짜와 좌석을 선택하여 예약 요청을 합니다.
4. **콘서트 좌석 결제**: 예약한 좌석에 대한 결제를 진행합니다.

### 유저 관련

1. **잔액 충전**: 서비스 이용에 필요한 잔액을 충전합니다.
2. **잔액 조회**: 현재 사용 가능한 잔액을 조회합니다.
3. **회원 가입**: 서비스를 이용하기 위해 회원으로 등록합니다

## 3. 시퀀스 다이어그램

### 유저 대기열 신청

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant US as 유저
    participant QS as 대기열
    
    participant DB as 데이터베이스

    U  ->>+ AS: 서비스 이용권 발급 요청 <br/> (요청 값: 사용자ID)
    note right of AS: 서비스 이용권은 토큰을 나타냅니다.
    AS ->>+ US: 해당 사용자가 <br/> 기존 서비스에 등록된 사용자인지 확인
    US ->>+ DB: 사용자 ID로 사용자 정보 조회
    DB ->>- US: 사용자 ID로 사용자로 조회한 정보 응답
    
    alt 유효한 회원일 때,
        US ->>- AS: 유저 정보 응답
        AS ->>+ QS: 대기열 정보 요청
        QS ->>+ DB: 대기열 상태 조회  <br/>(대기 순서, 남은 대기 시간)
        DB ->>- QS: 대기열 상태 반환 
        QS ->>- AS: 대기열 상태 반환
        AS ->> AS: 서비스 이용권 생성 <br/> 
        AS ->>+ DB: 서비스 이용권 저장 (이용권 내용: 사용자 ID, 대기 순서, 남은 대기 시간, 접근 가능 상태)
        DB ->>- AS: 서비스 이용권 응답
        AS ->>- U: 서비스 이용권, 대기열 정보 응답
    else 유효하지 않은 회원일 때,
        US ->>+ AS: 에러 메세지 응답 
        AS ->>- U: 에러 메세지 응답
    end
```

### 유저 대기열 확인

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant QS as 대기열
    participant DB as 데이터베이스

    loop 대기열 상태 5분 간격 확인
        U  ->>+ AS: 대기열 확인 요청 <br/> (요청: 서비스 이용권ID)
        AS ->>+ DB: 서비스 이용권 확인
        DB ->>- AS: 서비스 이용권 응답

        alt 서비스 이용권 상태가 <br/> '대기' 일 때,
            AS ->>+ QS: 대기열 상태 요청 
            QS ->>+ DB: 대기열 상태 조회 
            DB ->>- QS: 대기열 상태 반환 
            QS ->>- AS: 대기열 정보(예상 대기 시간, 순서) 반환 
            AS ->>- U: 대기열 정보 응답 
        else 서비스 이용권 상태가  <br/> '없을' 때,
            AS ->> U: 에러 메세지 응답
        end

        break 서비스 이용권 상태가 <br/>'활성화' 일 때,
            AS ->> U: 서비스 이용 가능 메세지 응답
        end 
    end
```

### 예약 가능 날짜 조회

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant CS as 콘서트 예약 
    participant DB as 데이터베이스

    U  ->>+ AS: 예약 가능한 날짜 조회 요청 <br/> (요청 값: 인증 정보, 콘서트ID)
    note right of AS: 서비스 이용권은 토큰을 나타냅니다.
    AS ->> AS: 서비스 이용권 상태 확인

    alt 서비스 이용권 상태가 대기 거나 없을 때,
        AS ->> U: 오류 메시지 반환
    else 서비스 이용권 상태가 활성화 상태 일때,
        AS ->>+ CS: 특정 콘서트의 예약 가능한 날짜 조회
        deactivate AS
        CS ->>+ DB: 특정 콘서트의 예약 가능한 날짜, 콘서트 정보 조회
        DB ->>- CS: 예약 가능한 콘서트 날짜, 콘서트 정보 응답
        CS ->> U:  예약 가능 날짜 목록 반환
        deactivate CS
    end
```

### 예약 가능 날짜의 좌석 조회

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant CS as 콘서트 예약 
    participant DB as 데이터베이스

    U  ->>+ AS: 좌석 조회 요청 <br/> (요청 값: 인증 정보, 콘서트ID, 날짜)
    note right of AS: 서비스 이용권은 토큰을 나타냅니다.
    AS ->> AS: 서비스 이용권 상태 확인

    alt 서비스 이용권 상태가 대기 거나 없을 때,
        AS ->> U: 오류 메시지 반환
    else 서비스 이용권 상태가 활성화 상태 일때,
        AS ->>+ CS: 예약 가능한 날짜의 좌석 조회
        deactivate AS
        CS ->>+ DB: 예약 가능한 날짜의 좌석 조회
        DB ->>- CS: 예약 가능한 날짜의 좌석 응답
        CS ->> U:  예약 가능한 날짜의 좌석 응답 <br/> (1 ~ 50 중 가능한 좌석)
        deactivate CS
    end
```

### 콘서트 좌석 예약

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant SS as 콘서트 예약 
    participant DB as 데이터베이스

    U  ->>+ AS: 좌석 예약 요청 <br/> (요청 값: 콘서트회차ID, 좌석번호, 서비스 이용권ID)
    note right of AS: 서비스 이용권은 토큰을 나타냅니다.
    AS ->> AS: 서비스 이용권 상태 확인

    alt 서비스 이용권 상태가 '대기' 거나 없을 때,
        AS ->>- U: 오류 메시지 반환
    else 서비스 이용권 상태가 '활성화' 상태 일때,
        AS ->>+ SS: 유저가 요청한 특정 좌석 조회 
        SS ->>+ DB: 특정 좌석 잠금, 좌석 상태 조회
        DB ->>- SS: 좌석 상태값 응답
        
        alt 좌석이 예약 가능할 때
            SS ->>+ DB: 예약 정보 저장
            DB ->>- SS: 결제 대기 예약 정보 응답
            SS ->>- U : 좌석 예약 성공, 좌석 ID 반환
        else 좌석이 예약 불가능 할 때
            SS ->> U: 예약 실패
        end 
            SS ->> DB: 좌석 잠금 해제
    end
```

### 콘서트 좌석 결제

```mermaid
sequenceDiagram
    actor U as 사용자
    participant AS as 서비스 이용권
    participant PS as 결제 
    participant DB as 데이터베이스

    U  ->>+ AS: 좌석 결제 요청 <br/> (요청 값: 예약ID)
    note right of AS: 서비스 이용권은 토큰을 나타냅니다.
    AS ->> AS: 서비스 이용권 상태 확인

    alt 서비스 이용권 상태가 '대기' 거나 없을 때,
        AS ->>- U: 오류 메시지 반환
    else 서비스 이용권 상태가 '활성화' 상태 일때,
        AS ->> PS: 좌석 결제 요청 
        PS ->>+ DB: 사용자 잔액 조회 요청 
        DB ->>- PS: 사용자 잔액 응답
        alt 사용자의 잔액이 충분할 때, 
            PS ->>+ DB: 잔액 차감, 예약 상태 확정으로 변경 요청
            DB ->>- PS: 잔액, 예약 상태 응답
            PS ->> U: 결제 완료 응답
        else 사용자의 잔액이 충분하지 않을 때, 
            PS ->> U: 잔액 부족으로 인한 결제 실패 응답
        end
    end
    
```

### 잔액 충전

```mermaid
sequenceDiagram
    actor U as 사용자
    participant PS as 포인트
    participant DB as 데이터베이스

    U ->>+ PS: 잔액 충전 요청 <br/> (요청 값: 충전할 금액, 유저ID)
    note right of PS: 다른 작업에서 이 포인트를 <br/> 동시에 사용할 수 없도록 임시로 잠급니다.

    PS ->>+ DB: 잔액 충전 요청
    DB ->> DB: 가용 잔액 잠금

    alt 충전 성공 
        DB ->> PS: 충전 완료 후 최종 잔액 반환
        DB ->> DB: 가용 잔액 해제
        PS ->>- U: 충전 후 총 잔액 반환
    else 충전 실패 
        DB ->>+ PS : 충전 실패 메시지 전달
        DB ->>- DB: 가용 잔액 해제
        PS ->>- U: 잔액 충전 실패 메시지 전달 
    end

```

### 잔액 조회

```mermaid
sequenceDiagram
    actor U as 사용자
    participant PS as 포인트
    participant DB as 데이터베이스

    U ->>+ PS: 잔액 조회 요청 <br/> (요청 값: 유저ID)
    PS ->>+ DB: 잔액 조회 요청

    alt 포인트 조회 성공 
        DB ->>- PS: 포인트 잔액 응답
        PS ->>- U: 잔액 정보 응답
    else 포인트 조회 실패 
        DB ->>+ PS : 잔액 조회 실패
        PS ->>- U: 잔액 조회 실패 응답
    end

```

### 회원가입

```mermaid
sequenceDiagram
    autonumber
    Actor U as 사용자
    participant US as 유저

    U ->>+ US: 회원가입 (요청: 이메일)
    US ->> US: 사용자 정보 저장
    %% 중복일 때도 적으면 좋겟당
    US -->>- U: 회원가입 완료 응답
```